import router from '@ohos.router';
import { FlipCard } from '../component/FlipCard';
import { util } from '@kit.ArkTS'
import { Question } from './QuestionBankPage';

@Entry
@Component
struct KnowledgeRecitePage {
  @State categories: string[] = []
  @State private selectedCategory: string = '';
  @State private currentIndex: number = 0;
  @State private isLoading: boolean = false;
  @State questions: Question[] = []
  @State totalQuestions: Question[] = []
  @State question: Question | null = null

  aboutToAppear(): void {
    this.loadCategories();
  }

  // åŠ è½½é¢˜ç›®åˆ†ç±»
  private async loadCategories(): Promise<void> {
    try {
      const context = getContext(this)
      const fileData = await context.resourceManager.getRawFileContent('arkts.json')
      const decoder = new util.TextDecoder('utf-8')
      const jsonStr = decoder.decodeWithStream(new Uint8Array(fileData.buffer))
      this.totalQuestions = JSON.parse(jsonStr)

      console.info(`é¢˜åº“é¡µé¢ - åŠ è½½äº† ${this.totalQuestions.length} ä¸ªé¢˜ç›®`)
      console.info(`é¢˜åº“é¡µé¢ - å½“å‰é€‰æ‹©çš„åˆ†ç±»: ${this.selectedCategory}`)

      // æå–æ‰€æœ‰åˆ†ç±»ï¼ˆå»æ‰ã€Œå…¨éƒ¨ã€é€‰é¡¹ï¼‰
      const categorySet = new Set<string>()
      this.totalQuestions.forEach(q => {
        if (q.category && q.category.trim() !== '') {
          categorySet.add(q.category)
        }
      })
      this.categories = Array.from(categorySet)

      console.info(`é¢˜åº“é¡µé¢ - æ‰€æœ‰åˆ†ç±»: ${JSON.stringify(this.categories)}`)
      if (this.categories.length > 0) {
        this.selectedCategory = this.categories[0];
        await this.loadProblems();
      }
      this.isLoading = false
    } catch (error) {
      console.error('Failed to load categories:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // åŠ è½½æŒ‡å®šåˆ†ç±»çš„é¢˜ç›®
  private async loadProblems(): Promise<void> {
    try {
      this.isLoading = true;
      
      // æŒ‰åˆ†ç±»ç­›é€‰é¢˜ç›®
      if (this.selectedCategory && this.selectedCategory.trim() !== '') {
        this.questions = this.totalQuestions.filter(q => q.category === this.selectedCategory)
        console.info(`é¢˜åº“é¡µé¢ - æŒ‰åˆ†ç±» "${this.selectedCategory}" è¿‡æ»¤åé¢˜ç›®æ•°é‡: ${this.questions.length}`)
      } else {
        // å¦‚æœæ²¡æœ‰é€‰æ‹©åˆ†ç±»ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¢˜ç›®
        this.questions = this.totalQuestions
        console.info(`é¢˜åº“é¡µé¢ - æ˜¾ç¤ºæ‰€æœ‰é¢˜ç›®æ•°é‡: ${this.questions.length}`)
      }
      
      // é‡ç½®å½“å‰é¢˜ç›®ç´¢å¼•
      this.currentIndex = 0;
      this.question = null;
      
    } catch (error) {
      console.error('Failed to load problems:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // åˆ‡æ¢åˆ†ç±»
  private async onCategoryChange(category: string): Promise<void> {
    if (this.selectedCategory === category) return;
    
    this.selectedCategory = category;
    await this.loadProblems();
  }

  // ä¸Šä¸€é¢˜
  private previousProblem(): void {
    if (this.currentIndex > 0) {
      this.currentIndex--;
    }
  }

  // ä¸‹ä¸€é¢˜
  private nextProblem(): void {
    if (this.currentIndex < this.questions.length - 1) {
      this.currentIndex++;
    }
  }

  // æ„å»ºåˆ†ç±»é€‰æ‹©å™¨
  @Builder
  private buildCategorySelector(): void {
    Column({ space: 16 }) {
      Text('é€‰æ‹©é¢˜ç›®åˆ†ç±»')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')

      // åˆ†ç±»æ ‡ç­¾
      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
        ForEach(this.categories, (category: string) => {
          Text(category)
            .fontSize(12)
            .fontColor(this.selectedCategory === category ? '#ffffff' : '#666666')
            .backgroundColor(this.selectedCategory === category ? '#1890ff' : '#f0f0f0')
            .padding({
              top: 6,
              bottom: 6,
              left: 12,
              right: 12
            })
            .borderRadius(6)
            .margin({
              right: 8,
              bottom: 8
            })
            .onClick(() => {
              this.onCategoryChange(category);
            })
        }, (category: string) => category)
      }
      .width('100%')
    }
    .alignItems(HorizontalAlign.Start)
    .width('100%')
    .padding(24)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#00000010',
      offsetX: 0,
      offsetY: 2
    })
  }

  // æ„å»ºå¡ç‰‡åŒºåŸŸ
  @Builder
  private buildCardArea(): void {
    if (this.questions.length === 0) {
      Column({ space: 16 }) {
        Text('ğŸ“š')
          .fontSize(48)
        
        Text('æš‚æ— é¢˜ç›®')
          .fontSize(16)
          .fontColor('#666666')
        
        Text('è¯·é€‰æ‹©å…¶ä»–åˆ†ç±»æˆ–ç¨åå†è¯•')
          .fontSize(14)
          .fontColor('#666666')
      }
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .width('100%')
      .height(300)
      .backgroundColor('#ffffff')
      .borderRadius(12)
      .shadow({
        radius: 4,
        color: '#00000010',
        offsetX: 0,
        offsetY: 2
      })
    } else {
      Column({ space: 16 }) {
        // è¿›åº¦æŒ‡ç¤ºå™¨
        Row({ space: 8 }) {
          Text(`${this.currentIndex + 1} / ${this.questions.length}`)
            .fontSize(14)
            .fontColor('#666666')
          
          Text(this.selectedCategory)
            .fontSize(14)
            .fontColor('#1890ff')
            .fontWeight(FontWeight.Medium)
        }
        .width('100%')

        // ç¿»è½¬å¡ç‰‡
        FlipCard({ problem: this.questions[this.currentIndex] })

        // å¯¼èˆªæŒ‰é’®
        Row({ space: 16 }) {
          Button('ä¸Šä¸€é¢˜')
            .fontSize(14)
            .fontColor(this.currentIndex > 0 ? '#ffffff' : '#666666')
            .backgroundColor(this.currentIndex > 0 ? '#1890ff' : '#FFFFFF')
            .borderRadius(8)
            .enabled(this.currentIndex > 0)
            .onClick(() => {
              this.previousProblem();
            })
            .layoutWeight(1)

          Button('ä¸‹ä¸€é¢˜')
            .fontSize(14)
            .fontColor(this.currentIndex < this.questions.length - 1 ? '#ffffff' : '#666666')
            .backgroundColor(this.currentIndex < this.questions.length - 1 ? '#1890ff' : '#f5f5f5')
            .borderRadius(8)
            .enabled(this.currentIndex < this.questions.length - 1)
            .onClick(() => {
              this.nextProblem();
            })
            .layoutWeight(1)
        }
        .width('100%')
      }
      .width('100%')
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Image($r('app.media.icon_back'))
            .width(24)
            .height(24)
            .fillColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor('#ffffff')
        .borderRadius(20)
        .onClick(() => {
          router.back();
        })

        Text('çŸ¥è¯†èƒŒè¯µ')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ç¬¦ä¿æŒå±…ä¸­
        Blank().width(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')

      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        Column() {
          Column({ space: 16 }) {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#1890ff')

          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
        }
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        }
        .justifyContent(FlexAlign.Center)
        .layoutWeight(1)
      } else {
        Scroll() {
          Column({ space: 24 }) {
            // åˆ†ç±»é€‰æ‹©å™¨
            this.buildCategorySelector()

            // å¡ç‰‡åŒºåŸŸ
            this.buildCardArea()
          }
          .width('100%')
          .padding(24)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}